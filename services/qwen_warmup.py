"""
–°–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–≥—Ä–µ–≤–∞ –º–æ–¥–µ–ª–µ–π Qwen –∏ Whisper, —á—Ç–æ–±—ã –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ.
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
"""
import asyncio
import logging
from io import BytesIO
from qwen_client import get_qwen_client
from whisper_client import transcribe_audio

logger = logging.getLogger(__name__)


async def warmup_qwen_model() -> None:
    """
    –ü—Ä–æ–≥—Ä–µ–≤–∞–µ—Ç –º–æ–¥–µ–ª—å Qwen –ø—Ä–æ—Å—Ç—ã–º –∑–∞–ø—Ä–æ—Å–æ–º.
    –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –¥–æ–ª–≥–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
    """
    try:
        logger.info("üî• –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≥—Ä–µ–≤ –º–æ–¥–µ–ª–∏ Qwen...")
        client = get_qwen_client()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≥—Ä–µ–≤–∞ –º–æ–¥–µ–ª–∏
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
        response = await asyncio.to_thread(
            client.generate_response,
            "–ü—Ä–∏–≤–µ—Ç"
        )
        
        logger.info(f"‚úì –ú–æ–¥–µ–ª—å Qwen –ø—Ä–æ–≥—Ä–µ—Ç–∞! –û—Ç–≤–µ—Ç: {response[:50]}...")
        return True
    except Exception as e:
        logger.warning(f"‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥—Ä–µ—Ç—å –º–æ–¥–µ–ª—å Qwen: {e}. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –º–æ–¥–µ–ª—å –ø—Ä–æ–≥—Ä–µ–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ.")
        return False


async def keep_qwen_warm() -> None:
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–µ–≥–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ "–∑–∞—Å—ã–ø–∞–ª–∞".
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ scheduler –∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç.
    """
    try:
        logger.debug("üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º keep-alive –∑–∞–ø—Ä–æ—Å –∫ Qwen...")
        client = get_qwen_client()
        
        # –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø—Ä–æ—Å—Ç–æ "—Ä–∞–∑–±—É–¥–∏—Ç—å" –º–æ–¥–µ–ª—å
        response = await asyncio.to_thread(
            client.generate_response,
            "–æ–∫"
        )
        
        logger.debug(f"‚úì Keep-alive —É—Å–ø–µ—à–µ–Ω: {response[:30]}...")
    except Exception as e:
        logger.warning(f"‚ö† Keep-alive –∑–∞–ø—Ä–æ—Å –∫ Qwen –Ω–µ —É–¥–∞–ª—Å—è: {e}. –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.")


async def warmup_whisper_model() -> None:
    """
    –ü—Ä–æ–≥—Ä–µ–≤–∞–µ—Ç –º–æ–¥–µ–ª—å Whisper –ø—Ä–æ—Å—Ç—ã–º –∑–∞–ø—Ä–æ—Å–æ–º.
    –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –¥–æ–ª–≥–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
    """
    try:
        logger.info("üé§ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≥—Ä–µ–≤ –º–æ–¥–µ–ª–∏ Whisper...")
        
        # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∞—É–¥–∏–æ (1 —Å–µ–∫—É–Ω–¥–∞ —Ç–∏—à–∏–Ω—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ WAV)
        # WAV –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è 1 —Å–µ–∫—É–Ω–¥—ã —Ç–∏—à–∏–Ω—ã –ø—Ä–∏ 16kHz, –º–æ–Ω–æ, 16-bit
        wav_header = bytes([
            0x52, 0x49, 0x46, 0x46,  # "RIFF"
            0x24, 0x00, 0x00, 0x00,  # —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ - 36 –±–∞–π—Ç
            0x57, 0x41, 0x56, 0x45,  # "WAVE"
            0x66, 0x6D, 0x74, 0x20,  # "fmt "
            0x10, 0x00, 0x00, 0x00,  # —Ä–∞–∑–º–µ—Ä fmt chunk
            0x01, 0x00,              # –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç (PCM)
            0x01, 0x00,              # –∫–∞–Ω–∞–ª—ã (–º–æ–Ω–æ)
            0x40, 0x3E, 0x00, 0x00,  # sample rate (16000 Hz)
            0x80, 0x7C, 0x00, 0x00,  # byte rate
            0x02, 0x00,              # block align
            0x10, 0x00,              # bits per sample (16)
            0x64, 0x61, 0x74, 0x61,  # "data"
            0x00, 0x00, 0x00, 0x00,  # —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (0 –±–∞–π—Ç - —Ç–∏—à–∏–Ω–∞)
        ])
        
        test_audio = BytesIO(wav_header)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        response = await transcribe_audio(test_audio, audio_format="wav")
        
        logger.info(f"‚úì –ú–æ–¥–µ–ª—å Whisper –ø—Ä–æ–≥—Ä–µ—Ç–∞! –û—Ç–≤–µ—Ç: {response[:50] if response else '–ø—É—Å—Ç–æ'}...")
        return True
    except Exception as e:
        logger.warning(f"‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥—Ä–µ—Ç—å –º–æ–¥–µ–ª—å Whisper: {e}. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –º–æ–¥–µ–ª—å –ø—Ä–æ–≥—Ä–µ–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ.")
        return False


async def keep_whisper_warm() -> None:
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–µ–≥–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Whisper, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –Ω–µ "–∑–∞—Å—ã–ø–∞–ª–∞".
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ scheduler —Ä–µ–∂–µ, —á–µ–º Qwen (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç), —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–µ.
    """
    try:
        logger.debug("üé§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º keep-alive –∑–∞–ø—Ä–æ—Å –∫ Whisper...")
        
        # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∞—É–¥–∏–æ (—Ç–∏—à–∏–Ω–∞)
        wav_header = bytes([
            0x52, 0x49, 0x46, 0x46, 0x24, 0x00, 0x00, 0x00, 0x57, 0x41, 0x56, 0x45,
            0x66, 0x6D, 0x74, 0x20, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00,
            0x40, 0x3E, 0x00, 0x00, 0x80, 0x7C, 0x00, 0x00, 0x02, 0x00, 0x10, 0x00,
            0x64, 0x61, 0x74, 0x61, 0x00, 0x00, 0x00, 0x00
        ])
        
        test_audio = BytesIO(wav_header)
        response = await transcribe_audio(test_audio, audio_format="wav")
        
        logger.debug(f"‚úì Whisper keep-alive —É—Å–ø–µ—à–µ–Ω: {response[:30] if response else '–ø—É—Å—Ç–æ'}...")
    except Exception as e:
        logger.warning(f"‚ö† Keep-alive –∑–∞–ø—Ä–æ—Å –∫ Whisper –Ω–µ —É–¥–∞–ª—Å—è: {e}. –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.")
